echo "Script run by xaoscience at 2025-08-25 09:13:30 UTC"
BUS_DEV=$(lsusb | grep 'UGREEN 25173' | awk '{print $2"/"$4}' | sed 's/://')
USB_PATH="/dev/bus/usb/${BUS_DEV}"
EXEC_FILE="usbreset"
if [ ! -f "$EXEC_FILE" ]; then
cat << 'EOF' > usbreset.c
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/ioctl.h>
#include <linux/usbdevice_fs.h>
int main(int argc, char **argv){
const char *filename;
int fd;
if(argc != 2){fprintf(stderr, "Usage: usbreset device-filename\n");return 1;}
filename = argv[1];
fd = open(filename, O_WRONLY);
if(fd < 0){perror("Error opening output file");return 1;}
if(ioctl(fd, USBDEVFS_RESET, 0) < 0){perror("Error in ioctl");return 1;}
close(fd);
return 0;
}
EOF
gcc -o "$EXEC_FILE" usbreset.c
fi
sudo "./${EXEC_FILE}" "${USB_PATH}"
YOUTUBE_HLS_URL='https://a.upload.youtube.com/http_upload_hls?cid=key&copy=0&file='
VIDEO_DEVICE="/dev/video0"
AUDIO_DEVICE="default"
ffmpeg \
-f v4l2 \
-thread_queue_size 1024 \
-input_format mjpeg \
-video_size 3840x2160 \
-framerate 60 \
-color_range 2 \
-i "$VIDEO_DEVICE" \
-f pulse \
-i "$AUDIO_DEVICE" \
-c:v hevc_nvenc \
-preset p7 \
-tune hq \
-b:v 17000k \
-maxrate 18000k \
-bufsize 34000k \
-vf "hwupload_cuda,scale_cuda=3840:2160:format=p010le,fps_cuda=fps=30" \
-g 60 \
-color_range 2 \
-colorspace bt2020nc \
-color_primaries bt2020 \
-color_trc smpte2084 \
-tag:v hvc1 \
-c:a aac \
-b:a 192k \
-f hls \
-hls_time 4 \
-hls_playlist_type event \
-hls_segment_filename 'file%03d.ts' \
-method PUT \
"$YOUTUBE_HLS_URL"